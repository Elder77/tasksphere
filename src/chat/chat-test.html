<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Prueba Chat Gateway</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <h1>💬 Prueba de WebSocket (Chat Gateway)</h1>

  <label>Ticket ID: <input id="tick_id" value="1"></label><br>
  <label>usua_cedula: <input id="usua_cedula" value="01020304050"></label><br>
  <label>Token (opcional): <input id="token" value=""></label><br>
  <button onclick="joinRoom()">Unirse a Ticket</button>

  <hr>

  <textarea id="message" placeholder="Escribe un mensaje"></textarea><br>
  <button onclick="sendMessage()">Enviar mensaje</button>

  <pre id="log"></pre>

  <script>
    let socket = null;

    function connectWithToken(token) {
      socket = io("http://localhost:3000/ws/tickets", {
        transports: ["websocket"],
        auth: { token: token ? `Bearer ${token}` : undefined },
      });

  socket.on("connect", () => log(`✅ Conectado: ${socket.id}`));
      socket.on("disconnect", () => log("❌ Conexión cerrada"));

      socket.on("message", (msg) => {
        log(`📩 Mensaje: ${JSON.stringify(msg)}`);
      });
    }

    // Note: connectWithToken will set up events

    function joinRoom() {
      const tick_id = parseInt(document.getElementById("tick_id").value);
      const token = document.getElementById("token").value;
      if (!socket) connectWithToken(token);
      socket.emit("join_ticket", { tick_id }, (res) => {
        log(`🟢 Join response: ${JSON.stringify(res)}`);
      });
    }

    function sendMessage() {
      const tick_id = parseInt(document.getElementById("tick_id").value);
      const message = document.getElementById("message").value;
      if (!socket) return log('🔴 No conectado. Primero pulsa "Unirse a Ticket" y proporciona token si aplica.');
      socket.emit("message", { tick_id, message }, (res) => {
        log(`📨 send response: ${JSON.stringify(res)}`);
      });
      document.getElementById("message").value = "";
    }

    function log(msg) {
      document.getElementById("log").textContent += msg + "\n";
    }
  </script>
</body>
</html>
